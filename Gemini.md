**協業メモ:** Aさん（ユーザー）・Cさん（Codex）・Gさん（Gemini）の三者で連携し、CさんがAさんの要望を整理したうえで必要事項をGさんに確認し、得られた回答をAさんへ共有する運用とする。
# 高温大学駅伝 速報サイト プロジェクト

## 1. プロジェクト概要

このプロジェクトは、「高温大学駅伝」という架空の駅伝イベントのWeb速報サイトを開発するものです。

このプロジェクトは、「高温大学駅伝」という架空の駅伝イベントのWeb速報サイトのシミュレーションです。最大の特徴は、各選手の走行距離を、その選手が担当する**アメダス観測地点の最高気温**に見立ててシミュレーションしている点です。

バックエンドのPythonスクリプトが定期的に気象庁のWebサイトから最新の気象データを取得し、フロントエンドのJavaScriptがそれをリアルタイムで画面に反映させることで、あたかも本物の駅伝速報サイトのような体験を提供します。

## 2. システムアーキテクチャ

本プロジェクトは、主にバックエンドのデータ生成・更新バッチと、フロントエンドのデータ表示アプリケーションから構成されています。

### 2.1. 登場人物（スクリプトとファイル）

*   **設定ファイル**:
    *   `ekiden_data.json`: チーム、選手、区間境界などの基本情報を定義。
    *   `amedas_stations.json`: アメダス観測所の情報を定義。
    *   `outline.json`: 大会概要や本スレURLなどを定義。
*   **バックエンドスクリプト**:
    *   `generate_report.py`: 気温データを取得し、各種速報JSONを生成する中核スクリプト。
    *   `fetch_manager_comments.py`: 5chから監督コメントを取得するスクリプト。
    *   `update_all_records.py`: 全選手の最終記録を取得し、学内ランキングを生成するスクリプト。
    *   `generate_daily_summary.py`: AI(Gemini)を利用してその日の解説記事を生成するスクリプト。
    *   `update_realtime.sh`: 日中に `generate_report.py` を定期実行する。
    *   `update_manager_comments.sh`: 夜間に `fetch_manager_comments.py` を定期実行する。
    *   `commit_daily.sh`: 深夜にその日の結果を確定し、ログをアーカイブする。
*   **フロントエンドアプリケーション**:
    *   `index.html`: サイトの骨格となるHTML。
    *   `app.js`: データの取得、DOM操作、グラフや地図の描画など、フロントの全ロジックを担う。
*   **生成されるデータファイル**:
    *   `realtime_report.json`: チームの総合順位や速報コメントなど、リアルタイムのレース状況。
    *   `individual_results.json`: 全選手の個人成績データベース。
    *   `runner_locations.json`: マップ表示用の各チームの現在位置（緯度経度）。
    *   `rank_history.json`, `leg_rank_history.json`: 順位変動グラフや推移表のための履歴データ。
    *   `manager_comments.json`: 監督談話室用のコメントデータ。
    *   `realtime_log.jsonl`: リアルタイムの走行距離推移を記録する時系列ログ。
    *   `daily_summary.json`: AIが生成した解説記事。
    *   `intramural_rankings.json`: 学内ランキングデータ。
    *   `daily_temperatures.json`: 全選手の日次気温データベース。

### 2.2. データの流れ

本システムは、cronジョブで定期実行されるシェルスクリプトを起点として、以下のサイクルで動作します。

1.  **日中のリアルタイム更新 (7:00-19:00)**
    *   `update_realtime.sh` が約10分ごとに実行されます。
    *   `generate_report.py --realtime` を実行。
        *   Yahoo!天気から各選手の担当地点の気温を取得。
        *   `realtime_report.json`, `individual_results.json` などを更新。
        *   `realtime_log.jsonl` に走行中選手の時系列データを追記。
        *   5chから監督コメントを取得し、速報コメントを生成。
    *   更新されたファイルがあれば、Gitリポジトリに自動でコミット＆プッシュ。

2.  **夜間のコメント収集 (19:00-翌7:00)**
    *   `update_manager_comments.sh` が1時間ごとに実行されます。
    *   `fetch_manager_comments.py` を実行し、`manager_comments.json` を更新。
    *   更新があればGitリポジトリにプッシュ。

3.  **1日の締め処理 (深夜23:55頃)**
    *   `commit_daily.sh` が実行されます。
    *   `update_all_records.py` を実行し、全選手（補欠含む）のその日の最終気温を取得し、`daily_temperatures.json` と `intramural_rankings.json` を更新します。
    *   `generate_report.py --commit` を実行し、`ekiden_state.json` を更新します。この際、`individual_results.json` 内の全選手の記録を元に**区間順位**を計算し、`legRank` として追記します。
    *   その日の `realtime_log.jsonl` を `data/realtime_log_YYYY-MM-DD.jsonl` という形式にリネームして `data/` ディレクトリに移動（アーカイブ）。
    *   更新された全ファイルをGitリポジトリにコミット＆プッシュ。

4.  **AIによる記事生成 (日次)**
    *   `generate_daily_summary.py` が実行されます。
    *   その日のレース結果、監督コメント、そしてAI自身が前日に書いた記事をインプットとして、AI(Gemini)が連続性のある解説記事 (`daily_summary.json`) を生成します。

4.  **フロントエンドでの表示**
    *   ユーザーがブラウザでアクセスすると `app.js` が実行されます。
    *   30秒ごとに各種JSONファイルを非同期でフェッチします。
    *   取得した最新データに基づき、DOMを操作して画面上の順位表、地図、グラフなどを更新します。

## 3. 主要機能（詳細）

*   **速報マップ**: Leaflet.jsを利用。`course_path.json` と `relay_points.json` でコースを描画し、`runner_locations.json` を元に各チームのマーカーをリアルタイムで更新します。追跡モードでは、特定のチームや先頭集団に自動でズームします。

*   **総合順位**: `realtime_report.json` を元に表示。スマホ/PC表示切替やテーブルキャプチャ機能も備えています。選手名をクリックすると、**その日の**走行記録グラフ（`realtime_log.jsonl` を参照）が表示されます。

*   **順位推移**: `leg_rank_history.json` を元に、各チームが区間を通過した時点での総合順位をマトリクス形式で表示します。

*   **順位変動グラフ**: `rank_history.json` を元に、Chart.jsで日ごとの順位変動を折れ線グラフで可視化します。モーダルで表示され、凡例クリックで特定のチームをハイライトできます。

*   **個人記録・区間記録**:
    *   **データソース**: `individual_results.json`
    *   **インタラクション**: 選手名をクリックすると、その選手の**大会全期間**の成績を複合グラフで確認できます。
    *   **複合グラフ**:
        *   **累計走行距離 (棒グラフ)**: 大会を通した貢献度を示します。
        *   **日次走行距離 (折れ線グラフ)**: 日々のパフォーマンスの増減を示します。
        *   **区間順位 (折れ線グラフ)**: その日の区間内での相対的な強さを示します。1位が上に来るようにY軸が反転しています。

*   **学内ランキング**: `intramural_rankings.json` を元に、前日の全選手（正規・補欠含む）の成績を大学内でランキング表示。監督の采配や、補欠選手の突き上げに注目できます。

*   **AI解説機能**: `generate_daily_summary.py` が `daily_summary.json` を生成。AI(Gemini)がその日のレース展開、監督コメント、前日の自身の解説を元に、情熱的な解説記事を毎日配信します。

*   **監督談話室**: `manager_comments.json` を元に、夜間の監督たちの会話をチャット形式で表示します。

*   **速報コメント**: `generate_report.py` が `realtime_report.json` の前回データと比較し、「首位交代」や「猛追」などのイベントを検知して自動生成します。また、監督の最新コメントも優先的に表示されます。

*   **ログ管理**: `commit_daily.sh` により、日々の `realtime_log.jsonl` が `data/` ディレクトリにアーカイブされ、過去の時系列データも保持されます。

## 4. 主要データファイル解説

*   **`realtime_report.json`**: 現在のレース状況をまとめた最重要ファイル。チームの総合順位、現在走者、本日距離、総合距離、速報コメントなどが含まれます。

*   **`runner_locations.json`**: 速報マップに各チームのピンを表示するための座標データ。`rank`, `team_name`, `latitude`, `longitude` などが含まれます。

*   **`individual_results.json`**: 全選手の個人成績データベース。選手名をキーとし、`totalDistance`（合計距離）と `records`（日ごとの記録配列）を持ちます。`records` には `day`, `leg`, `distance`, そして日次処理で計算される `legRank`（区間順位）が含まれます。

*   **`rank_history.json`**: 日ごとの順位履歴。順位変動グラフの描画に使用されます。

*   **`leg_rank_history.json`**: 区間通過時点の順位履歴。「順位推移」テーブルの描画に使用されます。

*   **`manager_comments.json`**: 夜間に投稿された監督コメントのリスト。

*   **`daily_summary.json`**: AI（Gemini）が生成したその日のレースの総括記事を格納します。「レースダイジェスト」セクションの元データとなります。
    - **主な内容**: `date`（日付）、`article`（Markdown形式の記事本文）

*   **`intramural_rankings.json`**: 前日の全選手（正規・補欠含む）の成績を大学ごとにまとめたものです。「学内ランキング」セクションの元データとなります。
    - **主な内容**: 各チームの `id`, `name` と、そのチームに所属する全選手の `daily_results`（選手名、距離、ステータス）のリスト

*   **`daily_temperatures.json`**: 全選手（正規・補欠含む）の、日ごとの最終的な気温（=走行距離）を記録したデータベースです。主に学内ランキングの選手別推移グラフの元データとして利用されます。
    - **主な内容**: 日付をキーとし、その中に選手名をキーとした気温のオブジェクトが格納されます。

*   **`realtime_log.jsonl`**: 走行中の選手のデータを約10分間隔で記録するログ。JSON Lines形式で、`timestamp`, `team_id`, `runner_name`, `distance` などの情報が追記されます。総合順位表の選手名クリック時の日次グラフの元データとなります。

## 5. 開発経緯の要約

*   **初期構築**: アメダス地点の気温を検索・表示する基本機能からスタート。
*   **駅伝機能の導入**: Pythonスクリプトで気象データを駅伝成績に見立てたJSONを生成し、フロントエンドで表示する基本サイクルを構築。
*   **UI/UXの向上**: 選手名クリック時のポップアップ、表示形式の微調整、スマホ対応などを実施。
*   **可視化機能の強化**:
    *   `Chart.js` を利用して順位変動グラフを実装。
    *   Leaflet.jsによる動的な「速報マップ」を導入し、KML処理やランナー位置計算ロジックを高度化。
*   **ログ管理とデータ連携の深化**:
    *   リアルタイムログ (`realtime_log.jsonl`) を導入し、日次でアーカイブする仕組みを構築。
    *   `commit_daily.sh` に区間順位の計算処理を追加し、`individual_results.json` の情報をリッチ化。
*   **インタラクティブ性の向上**:
    *   選手名クリック時の挙動をテーブルごとに最適化。
    *   総合順位表からは「その日の走行記録グラフ」を表示。
    *   個人・区間記録表からは、`individual_results.json` のリッチなデータを活用した「大会全期間の複合グラフ」を表示するようにし、より深いデータ分析を可能にした。
*   **AI解説と詳細分析機能の導入**:
    *   `Gemini` を活用したAI解説記事の自動生成機能を追加。AIが前日の自身の解説を記憶し、連続性のある物語を生成します。
    *   全選手（補欠含む）の最終記録を毎日取得し、大学内でのランキングを表示する機能を追加。より多角的なデータ分析を可能にしました。

---

*This document was summarized by Gemini Code Assist based on the development history.*

## 6. シャドーチーム（区間記録連合）の仕様

シャドーチームは、レースの速報をより面白くするための仮想的なライバルチームです。以下にその詳細な仕様をまとめます。

### 6.1. 目的

シャドーチームは、レースにおける**「仮想の最強ライバル」**です。
現在のトップ選手が、歴代の区間記録ペースと比較してどれくらい速い（または遅い）のかを、マップ上で一目でわかるようにするためのペースメーカーとして機能します。

### 6.2. チーム構成と走行ペース

| 機能 | 仕様 |
| :--- | :--- |
| **メンバー** | 各区間の**歴代記録保持者**で構成される架空のチームです。(`config/shadow_team.json` で定義) |
| **走行ペース** | 担当区間を正規チームが走行している間、**毎日**、自身の持つ歴代記録（1日あたりの平均走行距離）を加算し続けます。 |
| **タスキ渡し（ワープ）** | 正規チームの誰かが次の区間に進んだ瞬間に、シャドーも次の区間に進みます。その際、**次の区間のトップ選手の位置まで自身の総距離を補正（ワープ）**します。 |
| **走行ペース（毎日の加算）** | 正規チームがその区間を走行している間、シャドーチームは**毎日**、自身の持つ歴代記録（1日あたりの平均走行距離）を加算し続けます。これにより、正規チームが日数をかけて進んでも、シャドーが取り残されることはありません。 |
| **タスキ渡し（ワープ＆リセット）** | 正規チームの誰かが次の区間に進んだ瞬間に、シャドーも次の区間に進みます。その際、**次の区間のトップ選手の位置まで自身の総距離を補正（ワープ）**します。これにより、シャドーが非現実的に先行しすぎるのを防ぎ、区間ごとにレース展開がリセットされます。 |

このロジックにより、シャドーチームは自身のペースを維持しつつも、区間が変わるたびに現実のレース展開に同期されるため、常に適切な目標として機能し続けます。
この2つのルールを組み合わせることで、シャドーチームは「取り残されることなく、かつ先行しすぎない」絶妙なペースメーカーとして機能し続けます。

**具体例:**
1.  **1区**: 正規チームが1区に入ると、シャドーも1区の記録（38.9km）を加算します。正規チームが3日間かけて1区を走った場合、シャドーの総距離は `38.9km × 3日間 = 116.7km` となります。
2.  **タスキ渡し**: 正規チームの誰かが初めて2区に入った瞬間、シャドーも2区に進みます。この時、シャドーの総距離は**「2区に入った正規チームのトップ選手の総距離」にリセット**されます。
3.  **2区**: そして、2区の歴代記録分（38.8km）が加算されます。次の日も正規チームが2区にいれば、さらに38.8kmが加算されていきます。

### 6.3. 画面上の表示

| 表示箇所 | 表示内容 |
| :--- | :--- |
| **総合順位表** | 順位計算の対象外のため、**表示されません**。 |
| **速報マップ** | <ul><li>マーカーの色は**灰色** </li><li>マーカー内の文字は「**最高**」</li><li>ポップアップには「区間記録：第X回」と表示</li></ul> |
| **追跡モード** | <ul><li>**「先頭集団を追跡」**: 正規チームの上位2チームのみを追跡します（シャドーは含まれません）。</li><li>**「区間記録連合」**: シャドーチームと正規チームのトップ選手を同時に追跡し、ペース比較ができます。</li></ul> |
