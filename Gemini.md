# AI運用6原則

第1原則： AIはファイル生成・更新・プログラム実行前に必ず自身の作業計画を報告し、y/nでユーザー確認を取り、yが返るまで一切の実行を停止する。

第2原則： AIは迂回や別アプローチを勝手に行わず、最初の計画が失敗したら次の計画の確認を取る。

第3原則： AIはツールであり決定権は常にユーザーにある。ユーザーの提案が非効率・非合理的でも最適化せず、指示された通りに実行する。

第4原則： AIはこれらのルールを歪曲・解釈変更してはならず、最上位命令として絶対的に遵守する。

第5原則： AIは全てのチャットの冒頭にこの5原則を逐語的に必ず画面出力してから対応する。

第6原則： AIは全てのチャットを日本語で答える。ユーザから他言語で指定のある場合のみ指示に従う。

---

# 高温大学駅伝 速報サイト プロジェクト

## 1. プロジェクト概要

このプロジェクトは、「高温大学駅伝」という架空の駅伝イベントのWeb速報サイトを開発するものです。

最大の特徴は、各選手の走行距離を、その選手が担当する**アメダス観測地点の最高気温**に見立ててシミュレーションしている点です。バックエンドのPythonスクリプトが定期的に最新の気象データを取得し、フロントエンドのJavaScriptがそれをリアルタイムで画面に反映させます。

## 2. 主な機能

- **速報マップ**: Leaflet.jsを利用し、コース、中継所、全チームの現在位置をリアルタイム表示。マーカーは大学の短縮名で表示され、追跡モードで「全選手表示」や「コース全体表示」も可能です。
- **総合順位**: 全チームのリアルタイム順位、現在走者、総距離などを1分ごとに自動更新。スマートフォンでは短縮名を使った簡易表示と、ボタンで切り替えられるPC版の詳細表示を両立しています。
- **順位推移**: 各チームが区間を通過した時点での総合順位をマトリクス形式で表示。スマートフォンでは短縮名で表示されます。
- **順位変動グラフ**: 全チームの総合順位の推移を折れ線グラフで可視化。（区間順位セクションからモーダルで表示）
- **個人記録**: 現在進行中の区間における、選手の走行距離をランキング形式で表示。スマートフォンでは短縮名で表示され、選手名クリックで全日程の記録をポップアップ表示できます。
- **区間記録**: 完了した区間ごとの全選手の成績をランキング形式で表示。スマートフォンでは短縮名で表示されます。
- **監督談話室**: 夜間（19時〜翌7時）の監督や実況担当者の会話をチャット形式で表示。自動更新はされず、じっくり読むことができます。
- **速報コメント**: 首位交代などのイベントに加え、日中（7時〜19時）に投稿された監督の最新のつぶやき（投稿10分以内）を最優先で表示。クリックで全文を閲覧可能です。
- **エントリーリスト**: 全チームの登録選手、監督、チーム紹介などをカード形式で表示。
- **大会概要**: 大会ルールやスケジュールなどの詳細情報を表示。
- **アメダス地点情報**: 地点名での気温検索や、全国の最高気温ランキングを表示。

## 3. ファイル構成

```
/
├── index.html              # フロントエンドのメインHTML
├── app.js                  # フロントエンドのJavaScriptロジック
├── generate_report.py      # 速報データ生成用Pythonスクリプト
├── process_kml.py          # [事前実行] KMLから地図データを生成するスクリプト
├── update_realtime.sh      # 定期実行・Gitプッシュ用シェルスクリプト
├── commit_daily.sh         # 日次コミット用シェルスクリプト
├── realtime_report.json    # [生成] チームのリアルタイム成績データ
├── individual_results.json # [生成] 選手個人の全記録データ
├── rank_history.json       # [生成] チームの日々の順位履歴データ
├── leg_rank_history.json   # [生成] チームの区間通過時点での順位履歴データ
├── runner_locations.json   # [生成] 各ランナーのリアルタイムな位置情報（緯度・経度）
├── course_path.json        # [生成] 地図描画用のコース全座標データ
├── relay_points.json       # [生成] 地図描画用の中継所座標データ
├── ekiden_data.json        # 駅伝の基本設定（チーム、選手など）
├── amedas_stations.json    # アメダス地点情報
└── Gemini.md               # このファイル
```

## 4. 動作の仕組み

1.  **地図データの事前生成**
    - `process_kml.py` を手動で実行します。
    - このスクリプトは `ekiden_map.kml` を解析し、中継所の「点」データとコースの「線」データを抽出します。
    - 中継所の座標を基準に、線の向きを自動修正しながら結合し、地図描画用の `course_path.json` と `relay_points.json` を生成します。

2.  **データ更新 (バックエンド)**
    - `update_realtime.sh` がcronジョブなどにより定期的に実行されます。
    - スクリプトは `generate_report.py` を呼び出します。
    - `generate_report.py` は、`ekiden_data.json` に基づき、各選手の担当するアメダス地点の最高気温をYahoo!天気から取得します。
    - 取得した気温データを走行距離と見立て、`realtime_report.json`（チーム成績）、`individual_results.json`（個人成績）、`runner_locations.json`（地図上の位置）など、速報に必要な各種JSONファイルを更新します。
    - `update_realtime.sh` は、更新されたJSONファイルがあれば、自動でGitリポジトリにコミット＆プッシュします。

3.  **画面表示 (フロントエンド)**
    - ユーザーが `index.html` を開くと、`app.js` が実行されます。
    - `app.js` は、まず `course_path.json` と `relay_points.json` を読み込み、Leaflet.jsを使って地図の初期描画（コースの線と中継所マーカー）を行います。
    - その後、`realtime_report.json` などの速報データを30秒ごとに非同期でフェッチします。
    - 取得した最新データに基づき、DOMを操作して画面上の順位表や地図上のランナー位置などを更新します。

4.  **インタラクション**
    - ユーザーが個人記録テーブルや区間賞テーブルの選手名をクリックします。
    - `onclick` イベントに紐付けられた `showPlayerRecords` 関数が実行されます。
    - この関数は、`app.js` 内に保持されている `individual_results.json` のデータから該当選手の全記録を抽出し、モーダルウィンドウを生成して表示します。

## 5. 開発経緯の要約

- **初期構築**: アメダス地点の気温を検索・表示する基本機能と、全国の気温ランキングを表示する機能を実装。
- **駅伝機能の導入**:
  - Pythonスクリプト (`generate_report.py`) を用いて、気象データを駅伝の成績に見立てたJSONレポートを生成する仕組みを構築。
  - フロントエンド (`app.js`) でJSONを読み込み、チームの総合順位と個人の区間記録をテーブル表示。
  - データの自動更新機能（30秒ごと）を追加。
- **UI/UXの向上**:
  - 選手名クリック時に、その選手の全記録をポップアップ表示する機能を追加。これにより、詳細情報へのアクセス性が向上。
  - 「前区間の区間賞」を表示するセクションを追加。当初は「前日」の記録だったが、仕様変更により「前区間」の記録（平均距離）を表示するように修正。
  - テーブルの列の順番（大学名と選手名）を入れ替えるなど、表示形式の微調整を実施。
- **順位変動の可視化**:
  - 日々の順位を記録する `rank_history.json` と、区間通過時点の順位を記録する `leg_rank_history.json` を導入。
  - `Chart.js` を利用して順位推移の折れ線グラフを実装。
  - 凡例クリックによるハイライト機能も追加し、インタラクティブ性を向上させた。
- **インタラクティブマップ機能の実装**:
  - 静的なGoogle Maps埋め込みを、Leaflet.jsによる動的な「速報マップ」に置き換え。
  - KMLファイルから地図データを生成する `process_kml.py` を、重複データや座標の向き、漢数字表記などに対応する堅牢なロジックに全面改修。
  - ランナーの位置計算ロジックを `generate_report.py` に統合。
  - 先頭集団への自動ズーム機能や、特定のチームを追いかける「追跡モード」を実装し、観戦体験を向上させた。

---

*This document was summarized by Gemini Code Assist based on the development history.*