# 高温大学駅伝 速報サイト プロジェクト

## 1. プロジェクト概要

このプロジェクトは、「高温大学駅伝」という架空の駅伝イベントのWeb速報サイトを開発するものです。

このプロジェクトは、「高温大学駅伝」という架空の駅伝イベントのWeb速報サイトのシミュレーションです。最大の特徴は、各選手の走行距離を、その選手が担当する**アメダス観測地点の最高気温**に見立ててシミュレーションしている点です。

バックエンドのPythonスクリプトが定期的に気象庁のWebサイトから最新の気象データを取得し、フロントエンドのJavaScriptがそれをリアルタイムで画面に反映させることで、あたかも本物の駅伝速報サイトのような体験を提供します。

## 2. システムアーキテクチャ

本プロジェクトは、主にバックエンドのデータ生成・更新バッチと、フロントエンドのデータ表示アプリケーションから構成されています。

### 2.1. 登場人物（スクリプトとファイル）

*   **設定ファイル**:
    *   `ekiden_data.json`: チーム、選手、区間境界などの基本情報を定義。
    *   `amedas_stations.json`: アメダス観測所の情報を定義。
    *   `outline.json`: 大会概要や本スレURLなどを定義。
*   **バックエンドスクリプト**:
    *   `generate_report.py`: 気温データを取得し、各種速報JSONを生成する中核スクリプト。
    *   `fetch_manager_comments.py`: 5chから監督コメントを取得するスクリプト。
    *   `update_realtime.sh`: 日中に `generate_report.py` を定期実行する。
    *   `update_manager_comments.sh`: 夜間に `fetch_manager_comments.py` を定期実行する。
    *   `commit_daily.sh`: 深夜にその日の結果を確定し、ログをアーカイブする。
*   **フロントエンドアプリケーション**:
    *   `index.html`: サイトの骨格となるHTML。
    *   `app.js`: データの取得、DOM操作、グラフや地図の描画など、フロントの全ロジックを担う。
*   **生成されるデータファイル**:
    *   `realtime_report.json`: チームの総合順位や速報コメントなど、リアルタイムのレース状況。
    *   `individual_results.json`: 全選手の個人成績データベース。
    *   `runner_locations.json`: マップ表示用の各チームの現在位置（緯度経度）。
    *   `rank_history.json`, `leg_rank_history.json`: 順位変動グラフや推移表のための履歴データ。
    *   `manager_comments.json`: 監督談話室用のコメントデータ。
    *   `realtime_log.jsonl`: リアルタイムの走行距離推移を記録する時系列ログ。

### 2.2. データの流れ

本システムは、cronジョブで定期実行されるシェルスクリプトを起点として、以下のサイクルで動作します。

1.  **日中のリアルタイム更新 (7:00-19:00)**
    *   `update_realtime.sh` が5分ごとに実行されます。
    *   `generate_report.py --realtime` を実行。
        *   Yahoo!天気から各選手の担当地点の気温を取得。
        *   `realtime_report.json`, `individual_results.json` などを更新。
        *   `realtime_log.jsonl` に走行データを追記。
        *   5chから監督コメントを取得し、速報コメントを生成。
    *   更新されたファイルがあれば、Gitリポジトリに自動でコミット＆プッシュ。

2.  **夜間のコメント収集 (19:00-翌7:00)**
    *   `update_manager_comments.sh` が1時間ごとに実行されます。
    *   `fetch_manager_comments.py` を実行し、`manager_comments.json` を更新。
    *   更新があればGitリポジトリにプッシュ。

3.  **1日の締め処理 (深夜23:55頃)**
    *   `commit_daily.sh` が実行されます。
    *   `generate_report.py --commit` を実行。
        *   この際、`individual_results.json` 内の全選手の記録を元に**区間順位**を計算し、`legRank` として追記します。
    *   その日の `realtime_log.jsonl` を `data/realtime_log_YYYY-MM-DD.jsonl` という形式にリネームして `data/` ディレクトリに移動（アーカイブ）。
    *   更新された全ファイルをGitリポジトリにコミット＆プッシュ。

4.  **フロントエンドでの表示**
    *   ユーザーがブラウザでアクセスすると `app.js` が実行されます。
    *   30秒ごとに各種JSONファイルを非同期でフェッチします。
    *   取得した最新データに基づき、DOMを操作して画面上の順位表、地図、グラフなどを更新します。

## 3. 主要機能（詳細）

*   **速報マップ**: Leaflet.jsを利用。`course_path.json` と `relay_points.json` でコースを描画し、`runner_locations.json` を元に各チームのマーカーをリアルタイムで更新します。追跡モードでは、特定のチームや先頭集団に自動でズームします。

*   **総合順位**: `realtime_report.json` を元に表示。スマホ/PC表示切替やテーブルキャプチャ機能も備えています。選手名をクリックすると、**その日の**走行記録グラフ（`realtime_log.jsonl` を参照）が表示されます。

*   **順位推移**: `leg_rank_history.json` を元に、各チームが区間を通過した時点での総合順位をマトリクス形式で表示します。

*   **順位変動グラフ**: `rank_history.json` を元に、Chart.jsで日ごとの順位変動を折れ線グラフで可視化します。モーダルで表示され、凡例クリックで特定のチームをハイライトできます。

*   **個人記録・区間記録**:
    *   **データソース**: `individual_results.json`
    *   **インタラクション**: 選手名をクリックすると、その選手の**大会全期間**の成績を複合グラフで確認できます。
    *   **複合グラフ**:
        *   **累計走行距離 (棒グラフ)**: 大会を通した貢献度を示します。
        *   **日次走行距離 (折れ線グラフ)**: 日々のパフォーマンスの増減を示します。
        *   **区間順位 (折れ線グラフ)**: その日の区間内での相対的な強さを示します。1位が上に来るようにY軸が反転しています。

*   **監督談話室**: `manager_comments.json` を元に、夜間の監督たちの会話をチャット形式で表示します。

*   **速報コメント**: `generate_report.py` が `realtime_report.json` の前回データと比較し、「首位交代」や「猛追」などのイベントを検知して自動生成します。また、監督の最新コメントも優先的に表示されます。

*   **ログ管理**: `commit_daily.sh` により、日々の `realtime_log.jsonl` が `data/` ディレクトリにアーカイブされ、過去の時系列データも保持されます。

## 4. 主要データファイル解説

*   **`realtime_report.json`**: 現在のレース状況をまとめた最重要ファイル。チームの総合順位、現在走者、本日距離、総合距離、速報コメントなどが含まれます。

*   **`runner_locations.json`**: 速報マップに各チームのピンを表示するための座標データ。`rank`, `team_name`, `latitude`, `longitude` などが含まれます。

*   **`individual_results.json`**: 全選手の個人成績データベース。選手名をキーとし、`totalDistance`（合計距離）と `records`（日ごとの記録配列）を持ちます。`records` には `day`, `leg`, `distance`, そして日次処理で計算される `legRank`（区間順位）が含まれます。

*   **`rank_history.json`**: 日ごとの順位履歴。順位変動グラフの描画に使用されます。

*   **`leg_rank_history.json`**: 区間通過時点の順位履歴。「順位推移」テーブルの描画に使用されます。

*   **`manager_comments.json`**: 夜間に投稿された監督コメントのリスト。

*   **`realtime_log.jsonl`**: 走行中の選手のデータをリアルタイムで記録するログ。JSON Lines形式で、`timestamp`, `team_id`, `runner_name`, `distance` などの情報が追記されます。総合順位表の選手名クリック時の日次グラフの元データとなります。

## 5. 開発経緯の要約

*   **初期構築**: アメダス地点の気温を検索・表示する基本機能からスタート。
*   **駅伝機能の導入**: Pythonスクリプトで気象データを駅伝成績に見立てたJSONを生成し、フロントエンドで表示する基本サイクルを構築。
*   **UI/UXの向上**: 選手名クリック時のポップアップ、表示形式の微調整、スマホ対応などを実施。
*   **可視化機能の強化**:
    *   `Chart.js` を利用して順位変動グラフを実装。
    *   Leaflet.jsによる動的な「速報マップ」を導入し、KML処理やランナー位置計算ロジックを高度化。
*   **ログ管理とデータ連携の深化**:
    *   リアルタイムログ (`realtime_log.jsonl`) を導入し、日次でアーカイブする仕組みを構築。
    *   `commit_daily.sh` に区間順位の計算処理を追加し、`individual_results.json` の情報をリッチ化。
*   **インタラクティブ性の向上**:
    *   選手名クリック時の挙動をテーブルごとに最適化。
    *   総合順位表からは「その日の走行記録グラフ」を表示。
    *   個人・区間記録表からは、`individual_results.json` のリッチなデータを活用した「大会全期間の複合グラフ」を表示するようにし、より深いデータ分析を可能にした。

---

*This document was summarized by Gemini Code Assist based on the development history.*