# 要件定義・仕様書
更新日: 2025-10-09

## 文書の目的
- プロジェクト全体の期待値を明文化し、Aさん・Cさん・Gさん間で共有するベースラインとする。
- 既存の `docs/README.md`・`docs/Gemini.md`・`docs/Codex-notes.md` を補完し、変更要求が生じた際の参照点を提供する。

## ステークホルダー
- **Aさん (企画・要望調整)**: 新機能の要求やイベント運営上の要件を提示。ユーザー代表として優先度を決める。
- **Cさん (設計・実装・進行管理)**: 要件の具体化、スケジュール策定、実装と品質確保を担う。
- **Gさん (分析・レビュー・AI文章生成)**: データ分析や仕様確認、AI記事生成を担当。要件変更時には影響調査とレビューを実施。

## ユースケース
### 1. 速報閲覧者 (一般ユーザー)
- PC/スマホで大会速報ページにアクセスし、総合順位や地図、グラフを閲覧する。
- 選手名をクリックして個人の走行履歴グラフを確認する。
- 監督の速報コメントや談話室ログを追い、大会の流れを把握する。

### 2. 大会運営チーム (Aさん・Cさん)
- リアルタイム更新の状態確認、JSONの異常監視。
- AI生成記事や速報コメントをレビューし、必要に応じて修正する。
- 前日ログや学内ランキングなどのアーカイブを参照する。

### 3. 分析・レポート担当 (Gさん)
- バックエンドスクリプトの結果を確認し、異常値や欠損を検知する。
- AI記事生成の入力データをチェックし、記事の一貫性を保つ。
- 仕様変更時に影響範囲を洗い出し、改善案を提示する。

## 機能要件
### リアルタイム速報
- `generate_report.py --realtime` により 7:00–19:00 の間および要求タイミングで最新データを収集する。
- `data/realtime_report.json` に最新の総合順位・速報コメントが反映され、フロント (`index.html` / `app.js`) がポーリング表示する。
- マップ用 `data/runner_locations.json` と区間推移 `data/rank_history.json` が同期して更新される。

### 終了処理・日次集計
- 23:55 頃に `commit_daily.sh` が発火し、`ekiden_state.json`・`individual_results.json`・`daily_temperatures.json` などを確定保存する。
- `data/archive/` 配下に当日の `realtime_log.jsonl` を日付付きファイルとして移動し、履歴を蓄積する。

### AI 記事生成
- `generate_daily_summary.py` が Gemini へプロンプトを送信し、`data/daily_summary.json` と `data/article_history.json` に結果を保存する。
- 記事生成前に必要な要約や異常値のハイライトを Gさんがレビューする。

### コンテンツ表示
- フロントエンドは CDN から Leaflet.js、Chart.js などを読み込み、ランキング表・グラフ・モーダル等を描画する。
- モバイル環境ではレスポンシブテーブルへ自動切り替えを行い、主要情報を短縮名で表示する。

## 非機能要件
- **可用性**: バックエンド更新の失敗時には再実行可能であり、ログ (`logs/`) で失敗箇所を追跡できる。
- **性能**: ポーリング更新は 60 秒以内に完了し、フロントの主要指標が 3 秒以内にレンダリングされることを目標とする。
- **拡張性**: 次大会 (第16回) に向けて `index_16.html` / `app_16.js` にて並行開発が可能であること。
- **監視性**: スクリプト結果は `logs/` や Git コミットログで追跡できる。異常時は Slack/メール等への通知拡張を検討する。

## 運用要件
- cron で各シェル (`update_realtime.sh`, `update_manager_comments.sh`, `commit_daily.sh`) を定期実行し、Git へ自動コミット・プッシュする。
- 環境変数 (`.env`) に `PROD_PUSH_API_URL`・`API_SECRET_KEY` を設定し、Push 配信を制御する。無設定時は無害にスキップする。
- Yahoo!天気や 5ch スレッドの DOM 変更に備え、スクレイピング処理は例外を拾ってログと通知に残す。

## 制約とリスク
- 外部サービスの DOM/API 仕様変更でスクレイピングが停止する可能性がある。
- 自動コミット運用のため、コード変更とバッチ実行が衝突しないようにブランチ運用を調整する必要がある。
- AI 生成記事の品質ばらつきがあるため、公開前に人間のレビュー (Gさん→Cさん) を必須とする。

## 今後の検討項目
- 速報コメントの優先順位ロジック見直しと、イベント種別 (例: 区間賞更新) ごとのテンプレート化。
- `app_16.js` へのタイプセーフなリファクタリング (モジュール分割やテスト導入)。
- モニタリングダッシュボード (エラー検知・成功回数など) の整備。
- アーカイブ閲覧ページの自動生成と過去大会の切り替え導線強化。

